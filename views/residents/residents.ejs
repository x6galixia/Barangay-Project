<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/global/general.css">
    <link rel="stylesheet" href="../css/local/resident.css">
    <link rel="stylesheet" href="../css/local/id.css">
    <link href='https://fonts.googleapis.com/css?family=Poppins' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <title>
        <%= title %>
    </title>
</head>

<body>
    <%- include("../includes/header.ejs") %>
        <main class="mainContainer">
            <div class="heading" id="residentPageTitle">LIST OF RESIDENT</div>
            <div class="tableActionOne">
                <input type="search" id="searchInput" placeholder="Search..." aria-label="Search" />
                <select class="residents-dropdown" name="resident"">
                    <option value=" residents">Residents</option>
                    <option value="non-residents">Non-Residents</option>
                </select>
            </div>
            <div class=" tableContainer">
                <table>
                    <thead>
                        <tr>
                            <th>PUROK</th>
                            <th>FULLNAME</th>
                            <th>BIRTHDATE</th>
                            <th>AGE</th>
                            <th>GENDER</th>
                            <th>EDUC'L ATTAINMENT</th>
                            <th>OCCUPATION</th>
                            <th>REMARKS</th>
                            <th>ACTION</th>
                        </tr>
                    </thead>
                    <tbody id="residentsTableBody"></tbody>
                </table>
            </div>
            <nav aria-label="Page navigation" id="paginationNav">
                <% if (totalPages> 1) { %>
                    <% if (currentPage> 1) { %>
                        <a href="?page=<%= currentPage - 1 %>&limit=<%= limit %>"
                            aria-label="Previous Page">Previous</a>
                        <% } %>
                            <% if (currentPage < totalPages) { %>
                                <a href="?page=<%= currentPage + 1 %>&limit=<%= limit %>"
                                    aria-label="Next Page">Next</a>
                                <% } %>
                                    <% } %>
            </nav>
            <button id="add-resident-button" onclick="popUp_button(this)" class="addingForTable">
                ADD RESIDENT
            </button>

            <!-- Pop Up -->
            <!-- Add Resident -->
            <div class="pop-up" id="add-resident">

                <div class="close-container">
                    <img src="../icon/close.svg" alt="" class="close_popUp_for_resident">
                </div>
                <h1 class="heading">ADD RESIDENT</h1>
                <main>
                    <form id="formToAddResident" action="/residents/dashboard/add-resident" method="POST"
                        enctype="multipart/form-data">
                        <div class="add-resident-input-container">
                            <h3>Resident Personal Information</h3>
                            <input type="hidden" name="isResident" id="isResident">
                            <input type="text" id="globalId" name="globalId" hidden>
                            <div class="row">
                                <div class="inputWithLabel" id="surubadan">
                                    <label>Last Name</label>
                                    <input id="last_name" type="text" aria-label="Last Name" name="last_name" required>
                                </div>
                                <div class="inputWithLabel">
                                    <label>First Name</label>
                                    <input id="first_name" type="text" aria-label="First Name" name="first_name"
                                        required>
                                </div>
                                <div class="inputWithLabel">
                                    <label>Middle Name</label>
                                    <input id="middle_name" type="text" aria-label="Middle Name" name="middle_name"
                                        required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="inputWithLabel" id="masubad">
                                    <label>Gender</label>
                                    <select id="gender" name="gender" aria-label="Gender" id="" required>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                    </select>
                                </div>
                                <div class="inputWithLabel">
                                    <label>Birthdate</label>
                                    <input id="birthdate" type="date" aria-label="Birthdate" name="birthdate" required>
                                </div>
                                <div class="inputWithLabel">
                                    <label>Age</label>
                                    <input id="age" type="number" aria-label="Age" class="age" name="age" required
                                        readonly>
                                </div>
                            </div>
                            <div class="row">
                                <div class="inputWithLabel">
                                    <label>Educational Attainment</label>
                                    <input id="educAttainment" type="text" aria-label="Educational Attainment"
                                        name="educAttainment" required>
                                </div>
                                <div class="inputWithLabel">
                                    <label>Occupation</label>
                                    <input id="occupation" type="text" aria-label="Occupation" name="occupation"
                                        required>
                                </div>
                                <div class="inputWithLabel">
                                    <label>Sectors</label>
                                    <select name="sectors" id="sectors-dropdown" aria-label="Sectors">
                                        <option value="1">Government Employee</option>
                                        <option value="2">Private employee</option>
                                        <option value="3">Carpenters</option>
                                        <option value="4">Farmers</option>
                                        <option value="5">Fisherman</option>
                                        <option value="6">Business Entrepreneur</option>
                                        <option value="7">Drivers</option>
                                        <option value="8">OFW</option>
                                        <option value="9">Kasambahay</option>
                                        <option value="11">Entrepreneur</option>
                                        <option value="12">Unemployed</option>
                                        <option value="13">None</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="inputWithLabel">
                                    <label>Place of Birth</label>
                                    <input id="placeOfBirth" type="text" aria-label="Place of Birth" name="placeOfBirth"
                                        required>
                                </div>
                                <div class="inputWithLabel">
                                    <label>Gross Income</label>
                                    <input id="grossIncome" type="number" aria-label="Gross Income" name="grossIncome"
                                        required>
                                </div>
                                <div class="inputWithLabel">
                                    <label for="">Civil Status</label>
                                    <select id="civilStatus" name="civilStatus" id="">
                                        <option value="Single">Single</option>
                                        <option value="Married">Married</option>
                                        <option value="Widow">Widow</option>
                                        <option value="Widower">Widower</option>
                                    </select>
                                </div>
                            </div>
                            <div id="residentClassification">
                                <hr>
                                <h3 style="margin: 12px 0;">Resident Classification</h3>
                                <div class="row">
                                    <div class="inputWithLabel">
                                        <label>Senior</label>
                                        <select id="senior" name="senior" id="" aria-label="Senior">
                                            <option value="false">No</option>
                                            <option value="true">Yes</option>
                                        </select>
                                    </div>
                                    <div class="inputWithLabel">
                                        <label>Solo Parent</label>
                                        <select id="soloParent" name="soloParent" id="" aria-label="Solo Parent">
                                            <option value="false">No</option>
                                            <option value="true">Yes</option>
                                        </select>
                                    </div>
                                    <div class="inputWithLabel">
                                        <label>PWD</label>
                                        <select id="pwd" name="pwd" id="" aria-label="PWD">
                                            <option value="false">No</option>
                                            <option value="true">Yes</option>
                                        </select>
                                    </div>
                                    <div class="inputWithLabel">
                                        <label>Youth</label>
                                        <select id="youth" name="youth" id="" aria-label="Youth">
                                            <option value="false">No</option>
                                            <option value="true">Yes</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row" style="margin-top: 12px; align-items: end;">
                                    <div class="inputWithLabel">
                                        <label>4ps</label>
                                        <select id="is4ps" name="is4ps" id="" aria-label="4ps">
                                            <option value="false">No</option>
                                            <option value="true">Yes</option>
                                        </select>
                                    </div>
                                    <div class="inputWithLabel">
                                        <label>Out of School Youth</label>
                                        <select id="isOutOfSchoolYouth" name="isOutOfSchoolYouth" id=""
                                            aria-label="Out of School Youth">
                                            <option value="false">No</option>
                                            <option value="true">Yes</option>
                                        </select>
                                    </div>
                                    <div class="inputWithLabel">
                                        <label>Samahan ng Kababaihan ng Maypangdan</label>
                                        <select id="isSkm" name="isSkm" id=""
                                            aria-label="Samahan ng Kababaihan ng Maypangdan">
                                            <option value="false">No</option>
                                            <option value="true">Yes</option>
                                        </select>
                                    </div>
                                    <div class="inputWithLabel">
                                        <label>Kababayin an han Maypangdan</label>
                                        <select id="isKm" name="isKm" id="" aria-label="Kababayin an han Maypangdan">
                                            <option value="false">No</option>
                                            <option value="true">Yes</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <h3>Address</h3>
                            <div class="row" id="address-section">
                                <div class="inputWithLabel" id="purok">
                                    <label for="">Purok</label>
                                    <select id="purokIn" name="purok" aria-label="Purok">
                                        <option value="Seguidila">Seguidila</option>
                                        <option value="Sitaw">Sitaw</option>
                                        <option value="Talbos">Talbos</option>
                                        <option value="Petchay">Petchay</option>
                                        <option value="Ampalaya">Ampalaya</option>
                                        <option value="Mustaza">Mustaza</option>
                                        <option value="Kalabasa">Kalabasa</option>
                                    </select>
                                </div>
                                <div class="inputWithLabel" id="street">
                                    <label>Street</label>
                                    <input id="streetIn" type="text" aria-label="Street" name="street" required>
                                </div>
                                <div class="inputWithLabel">
                                    <label>Barangay</label>
                                    <input id="barangay" type="text" aria-label="Barangay" id="barangay" name="barangay"
                                        required value="Maypangdan">
                                </div>
                                <div class="inputWithLabel">
                                    <label>Municipality</label>
                                    <input id="city" type="text" aria-label="City" id="city" name="city" required
                                        value="Borongan City">
                                </div>
                                <div class="inputWithLabel">
                                    <label>Province</label>
                                    <input id="province" type="text" aria-label="Province" id="province" name="province"
                                        required value="Eastern Samar">
                                </div>
                            </div>
                            <div id="addressWhileStudying" style="display: none;">
                                <hr>
                                <h3 style="margin: 12px 0;">Address While Studying</h3>
                                <div class="row">
                                    <div class="inputWithLabel">
                                        <label for="">Purok</label>
                                        <select id="purok1" name="purok1" aria-label="Purok" disabled>
                                            <option value="Seguidila">Seguidila</option>
                                            <option value="Sitaw">Sitaw</option>
                                            <option value="Talbos">Talbos</option>
                                            <option value="Petchay">Petchay</option>
                                            <option value="Ampalaya">Ampalaya</option>
                                            <option value="Mustaza">Mustaza</option>
                                            <option value="Kalabasa">Kalabasa</option>
                                        </select>
                                    </div>
                                    <div class="inputWithLabel">
                                        <label>Street</label>
                                        <input id="street1" type="text" aria-label="Street" name="street1" disabled>
                                    </div>
                                    <div class="inputWithLabel">
                                        <label>Barangay</label>
                                        <input id="barangay1" type="text" aria-label="Barangay" name="barangay1"
                                            value="Maypangdan" disabled>
                                    </div>
                                    <div class="inputWithLabel">
                                        <label>Municipality</label>
                                        <input id="city1" type="text" aria-label="City" name="city1"
                                            value="Borongan City" disabled>
                                    </div>
                                    <div class="inputWithLabel">
                                        <label>Province</label>
                                        <input id="province1" type="text" aria-label="Province" name="province1"
                                            value="Eastern Samar" disabled>
                                    </div>
                                    <div class="inputWithLabel">
                                        <label>Boarding House Name</label>
                                        <input id="boardingHouse" type="text" aria-label="Boarding House Name"
                                            name="boardingHouse" disabled>
                                    </div>
                                    <div class="inputWithLabel">
                                        <label>Landlord</label>
                                        <input id="landlord" type="text" aria-label="Landlord" name="landlord" disabled>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <h3>Emergency Contact Person</h3>
                            <div>
                                <div class="row">
                                    <div class="inputWithLabel" id="surubadan">
                                        <label>Last Name</label>
                                        <input id="emergencyLastName" type="text" aria-label="Last Name"
                                            name="emergencyLastName" required>
                                    </div>
                                    <div class="inputWithLabel">
                                        <label>First Name</label>
                                        <input id="emergencyFirstName" type="text" aria-label="First Name"
                                            name="emergencyFirstName" required>
                                    </div>
                                    <div class="inputWithLabel">
                                        <label>Middle Name</label>
                                        <input id="emergencyMiddleName" type="text" aria-label="Middle Name"
                                            name="emergencyMiddleName" required>
                                    </div>
                                    <div class="inputWithLabel">
                                        <label>Contact Number</label>
                                        <input id="emergencyContactNumber" type="number" aria-label="Contact Number"
                                            name="emergencyContactNumber" required>
                                    </div>
                                </div>
                                <div class="row" id="emergencyContactInfo" style="margin-top: 12px;">
                                    <div id="emergencyPurok" class="inputWithLabel">
                                        <label for="">Purok</label>
                                        <select name="emergencyPurok" id="emergencyPurokIn" aria-label="Purok">
                                            <option value="Seguidila">Seguidila</option>
                                            <option value="Sitaw">Sitaw</option>
                                            <option value="Talbos">Talbos</option>
                                            <option value="Petchay">Petchay</option>
                                            <option value="Ampalaya">Ampalaya</option>
                                            <option value="Mustaza">Mustaza</option>
                                            <option value="Kalabasa">Kalabasa</option>
                                        </select>
                                    </div>
                                    <div id="emergencyStreet" class="inputWithLabel">
                                        <label>Street</label>
                                        <input id="emergencyStreetIn" type="text" aria-label="Street"
                                            name="emergencyStreet" required>
                                    </div>
                                    <div class="inputWithLabel">
                                        <label>Barangay</label>
                                        <input type="text" aria-label="Barangay" id="emergencyBarangay"
                                            name="emergencyBarangay" required>
                                    </div>
                                    <div class="inputWithLabel">
                                        <label>Municipality</label>
                                        <input type="text" aria-label="City" id="emergencyCity" name="emergencyCity"
                                            required>
                                    </div>
                                    <div class="inputWithLabel">
                                        <label>Province</label>
                                        <input type="text" aria-label="Province" id="emergencyProvince"
                                            name="emergencyProvince" required>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <h3>ID Picture</h3>
                            <div class="ID-container">
                                <video id="webcam" autoplay style="display: none; margin-bottom:24px"></video>
                                <canvas id="canvas" style="display: none;"></canvas>
                                <div class="image-preview" id="imagePreview">
                                    <p>No image uploaded</p>
                                </div>
                                <div class="buttons">
                                    <button type="button" class="button capture"
                                        onclick="captureImage()">Capture</button>
                                    <button type="button" class="button upload"
                                        onclick="triggerUpload()">Upload</button>
                                    <input type="file" id="fileInput" name="picture" accept="image/*"
                                        onchange="displayImage(event)">
                                </div>
                            </div>
                        </div>
                        <button type="submit" id="submit_add_resident">SUBMIT</button>
                    </form>
                </main>
            </div>
            <!-- Generate ID -->
            <style>
                @media print {
                    * {
                        -webkit-print-color-adjust: exact;
                        /* For Chrome */
                        print-color-adjust: exact;
                        /* For other browsers */
                    }

                    #residentPageTitle,
                    .overlay,
                    header,
                    .tableContainer,
                    button,
                    input,
                    select,
                    h1,
                    .close-container {
                        display: none !important;
                    }

                    .pop-up {
                        box-shadow: none !important;
                    }
                }
            </style>
            <div class="pop-up" id="generate-ID">
                <div class="close-container">
                    <img src="../icon/close.svg" alt="" class="close_popUp">
                </div>
                <h1 class="heading">BARANGAY ID</h1>
                <main>
                    <div class="center">
                        <div class="id-container">
                            <div class="first-layout">
                                <div><img src="../images/logo3.png" alt=""></div>
                                <div>
                                    <p>Republic of the Philippines <br>
                                        Province of Eastern Samar <br>
                                        City of Borongan <br>
                                        BARANGAY MAYPANGDAN</p>
                                </div>
                                <div><img src="../images/logo4.png" alt=""></div>
                            </div>
                            <div class="sub-head">
                                <h2>BARANGAY ID</h2>
                            </div>

                            <div class="id-img">
                                <img id="residentPicture" src="../images/wow.jpg" alt="">
                                <p id="idNumber">ID NUMBER</p>
                                <H2 id="fullname">FULL NAME</H2>

                            </div>

                            <div class="personal-info">
                                <h2 class="perso-info">PERSONAL INFORMATION</h2>
                                <p>
                                    <span class="Civil-stat">Civil Status:</span>
                                    <span class="value" id="IDcivilStatus">Status</span>
                                </p>
                                <p>
                                    <span class="Civil-stat">Birthdate:</span>
                                    <span class="value" id="IDbirthdate">Birthdate</span>
                                </p>
                                <p>
                                    <span class="Civil-stat" style="margin-right: 2px;">Address:</span>
                                    <span class="value" id="address">Address</span>
                                </p>
                            </div>

                            <div class="signature-container">
                                <hr class="signature-line">
                                <span class="signature-text">Signature</span>
                            </div>
                        </div>
                        <div class="id-back">
                            <div class="lgu">
                                <h2>LGU-MAYPANGDAN</h2>
                                <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This is to certify that the bearer of this card
                                    whose
                                    picture and signature appear herein is a resident of Barangay Maypangdan Borongan
                                    City.
                                </p>
                            </div>
                            <div class="qr-img" id="qrcode">
                            </div>
                            <div class="qr-imager">
                                <div>
                                    <p>This card is non-transferrable.</p>
                                    <p>Valid only until <span id="IDvalidation"></span></p>
                                </div>
                            </div>

                            <div class="personal-info">
                                <div class="notify">
                                    <h2>INCASE OF EMERGENCY, NOTIFY:</h2>
                                </div>
                                <p>
                                    <span class="Civil-stat">Contact Person:</span>
                                    <span class="values" id="emergencyContactName">Contact Person</span>
                                </p>
                                <p>
                                    <span class="Civil-stat">Contact Number:</span>
                                    <span class="value" id="IDemergencyContactNumber">Contact Number</span>
                                </p>
                                <p>
                                    <span class="Civil-stat" style="margin-right: 2px;">Address:</span>
                                    <span class="value" id="emergencyContactAddress">Contact Person Address</span>
                                </p>
                                <div class="signature-containers">
                                    <p class="name">IAN C. GONZALES</p>
                                    <p class="position">Punong Baranggay</p>
                                </div>
                            </div>
                            <div class="bottom">

                            </div>
                        </div>

                    </div>
                    <button onclick="window.print()">Print</button>
                </main>
            </div>

            <!-- Delete Pop-up -->
            <div class="pop-up-confirm" id="delete-resident">
                <div>
                    <div class="reject-heading">
                        <img src="../icon/warning.svg" alt="">
                        <h2>Deleting a Resident will <br>
                            automatically delete from the list</h2>
                    </div>
                    <main>
                        <h2>Are sure you want to delete this Resident?</h2>
                        <div>
                            <button type="button" id="cancel-delete" class="button-bordered close_popUp1">No</button>
                            <button type="button" id="confirm-delete" class="button-bordered">Yes</button>
                        </div>
                    </main>
                </div>
            </div>

            <% if (messages.success) { %>
                <div class="overlay"></div>
                <div class="alert alert-success" id="submit_prompt">
                    <img src="../images/success-img.png" alt="">
                    <div>
                        <h2>
                            <%= messages.success %>
                        </h2>
                        <main>
                            <button type="button" class="button-green" onclick="closePopup()">Ok</button>
                        </main>
                    </div>
                </div>
                <% } %>
        </main>
</body>
<script src="../../js/global/pop-up.js"></script>
<script src="../../js/local/residents/residents-api.js"></script>
<script>
    document.querySelector("header>nav>ul>li:nth-child(3)").classList.toggle("selected");

    // Function to simulate image capture
    function captureImage() {
    const webcam = document.getElementById("webcam");
    const canvas = document.getElementById("canvas");
    const preview = document.getElementById("imagePreview");
    const fileInput = document.getElementById("fileInput");
    
    // Check if webcam is already streaming
    if (!webcam.srcObject) {
        // Access the user's webcam
        navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
                webcam.srcObject = stream;
                preview.style.display = "none";
                webcam.style.display = "block"; // Show the webcam
            })
            .catch(err => {
                alert("Unable to access the camera: " + err.message);
            });
    } else {
        // Capture image from webcam
        preview.style.display = "flex";
        const context = canvas.getContext("2d");
        canvas.width = webcam.videoWidth;
        canvas.height = webcam.videoHeight;
        context.drawImage(webcam, 0, 0, canvas.width, canvas.height);

        // Stop webcam stream
        const stream = webcam.srcObject;
        const tracks = stream.getTracks();
        tracks.forEach(track => track.stop());
        webcam.srcObject = null;
        webcam.style.display = "none";

        // Display captured image
        const imageData = canvas.toDataURL("image/png");
        preview.innerHTML = `<img src="${imageData}" alt="Captured Image">`;

        // Convert base64 image to Blob and then to a File object
        const byteString = atob(imageData.split(',')[1]); // Decode base64 string
        const ab = new ArrayBuffer(byteString.length);
        const ia = new Uint8Array(ab);
        for (let i = 0; i < byteString.length; i++) {
            ia[i] = byteString.charCodeAt(i);
        }
        const blob = new Blob([ab], { type: 'image/png' });
        const file = new File([blob], "captured_image.png", { type: "image/png" });

        // Create a DataTransfer object to simulate file input
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);

        // Assign the file to the file input element
        fileInput.files = dataTransfer.files;
    }
}

// Function to trigger file input click
function triggerUpload() {
    document.getElementById("fileInput").click();
}

// Function to display the selected image
function displayImage(event) {
    const file = event.target.files[0];
    const preview = document.getElementById("imagePreview");

    if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
            preview.innerHTML = `<img src="${e.target.result}" alt="Uploaded Image">`;
        };
        reader.readAsDataURL(file);
    } else {
        preview.innerHTML = `<p>No image uploaded</p>`;
    }
}

</script>

</html>