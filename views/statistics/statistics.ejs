<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/global/general.css">
    <link rel="stylesheet" href="../css/local/statistics.css">
    <link href='https://fonts.googleapis.com/css?family=Poppins' rel='stylesheet'>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>
        <%= title %>
    </title>
</head>

<body>
    <%- include("../includes/header.ejs") %>

        <div class="container">
            <div class="statsMainContainer">

                <h1>Residents Classification</h1>
                <div id="meow">
                    <!-- <div class="chart">
                        <canvas id="barangayPopulationChart"></canvas>
                    </div> -->
                    <div class="separate">
                        <div>
                            <h3 style="margin-left: 0;">Total Resident Classification</h3>
                            <div id="overallPopulation" class="oberall"></div>
                        </div>
                        <div id="totalsByPurokDetails"></div>
                    </div>
                </div>
            </div>
            <hr>
            <div class="statsMainContainer">

                <h1>Resident Status</h1>
                <div id="meow">
                    <!-- <div class="chart">
                        <canvas id="statusChart"></canvas>
                    </div> -->
                    <div class="separate">
                        <div>
                            <h3 style="margin-left: 0;">Total Resident Status</h3>
                            <div id="overallPopulationStatus1" class="oberall"></div>
                        </div>
                        <div id="residentStatusText"></div>
                    </div>
                </div>
            </div>
            <hr>
            <div class="statsMainContainer">

                <h1>Age Demographics</h1>
                <div id="meow">
                    <!-- <div class="chart">
                        <canvas id="ageDemographicsChart"></canvas>
                    </div> -->
                    <div class="separate">
                        <div>
                            <h3>Total Age Demographics</h3>
                            <div id="overallPopulationAge" class="oberall"></div>
                        </div>
                        <div id="ageDemographicsText"></div>
                    </div>
                </div>
            </div>
            <hr>
            <div class="statsMainContainer">
                <div style="display: flex; align-items: center; justify-content: space-between; margin: 20px 3%; width: 100%;">
                    <h1>Household Classification</h1>
                    <button id="add-survey-button" onclick="popUp_button(this)"><p>ADD SURVEY</p></button>
                </div>
                <div id="meow">
                    <div class="separate">
                        <div style="align-self: self-start; display: flex; flex-direction: column; gap: 4px; width: fit-content;">
                            <label for="year-dropdown">Select Year: </label>
                            <select id="year-dropdown"></select>
                        </div>
                        <div class="oberallContainer">
                            <h3 style="margin-left: 0;">Overall Statistics</h3>
                            <div id="overall-container" class="oberall">
                                <!-- Overall data will be inserted here -->
                            </div>
                        </div>
                        <div>
                            <h3 style="margin-left: 0;">Household Classification by Purok</h3>
                            <div id="statistics-container">
                                <!-- Data will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <hr>
            <div class="statsMainContainer">
                <h1>Resident Sectors</h1>
                <div id="meow">
                    <!-- <div class="chart">
                        <canvas id="barangayPopulationChart1"></canvas>
                    </div> -->
                    <div class="separate">
                        <div id="classificationByPurokDetails"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="pop-up" id="add-survey">

            <div class="close-container">
                <img src="../icon/close.svg" alt="" class="close_popUp">
            </div>
            <h1 class="heading">HOUSE CLASSIFICATION</h1>
            <main>
                <form id="formToAddResident" action="/statistics/house-classification-survey" method="POST">
                    <div class="add-survey-input-container">
                        <div class="row">
                            <div id="surveyPurok" class="inputWithLabel">
                                <label for="">Purok</label>
                                <select name="surveyPurok" id="surveyPurok" aria-label="Purok">
                                    <option value="Seguidila">Seguidila</option>
                                    <option value="Sitaw">Sitaw</option>
                                    <option value="Talbos">Talbos</option>
                                    <option value="Petchay">Petchay</option>
                                    <option value="Ampalaya">Ampalaya</option>
                                    <option value="Mustaza">Mustaza</option>
                                    <option value="Kalabasa">Kalabasa</option>
                                </select>
                            </div>
                            <div class="inputWithLabel">
                                <label>House Number (Optional)</label>
                                <input type="number" aria-label="House Number (Optional)" name="houseNumber" min="1">
                            </div>
                            <div class="inputWithLabel" id="surubadan">
                                <label>House Representative</label>
                                <input type="text" aria-label="House Representative" name="houseRepresentative"
                                    required>
                            </div>
                            <div class="inputWithLabel">
                                <label>Number of Families</label>
                                <input type="number" aria-label="Number of Families" name="numberOfFamilies" min="1"
                                    required>
                            </div>
                            <div class="inputWithLabel" id="masubad">
                                <label>With CR</label>
                                <select name="isWithCr" aria-label="With CR" required>
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                            <div class="inputWithLabel" id="masubad">
                                <label>With 40m Zone</label>
                                <select name="isWith40mZone" aria-label="With 40m Zone" required>
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                            <div class="inputWithLabel" id="masubad">
                                <label>Energized</label>
                                <select name="isEnergized" aria-label="Energized" required>
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                            <div class="inputWithLabel" id="masubad">
                                <label>Housing Materials</label>
                                <select name="housingMaterials" aria-label="Housing Materials" required>
                                    <option value="Concrete">Concrete</option>
                                    <option value="Semi-Concrete">Semi-Concrete</option>
                                    <option value="Wood">Wood</option>
                                </select>
                            </div>
                            <div class="inputWithLabel" id="masubad">
                                <label>Water Sources</label>
                                <div style="display: flex; gap: 12px;">
                                    <label style="display: flex; align-items: center; gap: 6px;">
                                        <input type="checkbox" name="deepWell" value="Deep Well">
                                        Deep Well
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 6px;">
                                        <input type="checkbox" name="waterPump" value="Water Pump">
                                        Water Pump
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 6px;">
                                        <input type="checkbox" name="mineral" value="Mineral">
                                        Mineral
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" id="submit_add_survey"
                        style="display: flex; margin-left: auto;">SUBMIT</button>
                </form>
            </main>
        </div>

</body>
<script src="../../js/global/pop-up.js"></script>
<script src="../../js/local/statistics/statistics-api.js"></script>
<script>
    document.querySelector("header>nav>ul>li:nth-child(6)").classList.toggle("selected");
</script>

<script>
    function fetchAvailableYears() {
        $.get('/statistics/available-years', function (data) {
            const yearDropdown = $('#year-dropdown');
            yearDropdown.empty(); // Clear any existing options

            // Populate the dropdown with years
            data.forEach(item => {
                yearDropdown.append(new Option(item.year, item.year));
            });

            // Optionally, set the default selected year to the first available one
            if (data.length > 0) {
                fetchStatistics(data[0].year); // Fetch data for the first available year
                yearDropdown.val(data[0].year); // Set the default year in the dropdown
            }
        }).fail(function () {
            alert('Failed to fetch available years');
        });
    }

    // Fetch statistics for the selected year
    function fetchStatistics(year) {
        $.get(`/statistics/house-classification?year=${year}`, function (data) {
            $('#year').text(data.year);

            // Display individual statistics by purok
            let statisticsHtml = '<table><thead><tr><th>Purok</th><th>Concrete</th><th>Semi-Concrete</th><th>Wood</th><th>Deep Well</th><th>Water Pump</th><th>Mineral</th><th>Household</th><th>Families</th><th>with CR</th><th>40m Zone</th><th>Energized</th></tr></thead><tbody>';

            data.statistics.forEach(stat => {
                statisticsHtml += `
                    <tr>
                        <td>${stat.purok}</td>
                        <td>${stat.concrete_count}</td>
                        <td>${stat.semi_concrete_count}</td>
                        <td>${stat.wood_count}</td>
                        <td>${stat.deep_well_count}</td>
                        <td>${stat.water_pump_count}</td>
                        <td>${stat.mineral_count}</td>
                        <td>${stat.total_house_classifications}</td>
                        <td>${stat.total_families}</td>
                        <td>${stat.total_with_cr}</td>
                        <td>${stat.total_with_40m_zone}</td>
                        <td>${stat.total_energized}</td>
                    </tr>
                `;
            });

            statisticsHtml += `</tbody></table>`;
            $('#statistics-container').html(statisticsHtml);

            // Display overall statistics
            let overallHtml = `
                <div><h5>Total Household</h5> <h3>${data.overall.overall_house_classifications}</h3></div>
                <div><h5>Total Families</h5> <h3>${data.overall.overall_families}</h3></div>
                <div><h5>Total with CR</h5> <h3>${data.overall.overall_with_cr}</h3></div>
                <div><h5>Total with 40m Zone</h5> <h3>${data.overall.overall_with_40m_zone}</h3></div>
                <div><h5>Total Energized</h5> <h3>${data.overall.overall_energized}</h3></div>
            `;
            $('#overall-container').html(overallHtml);
        }).fail(function () {
            alert('Failed to fetch statistics');
        });
    }

    // Update statistics when a new year is selected
    $('#year-dropdown').change(function () {
        const selectedYear = $(this).val();
        fetchStatistics(selectedYear); // Fetch and display data for the selected year
    });

    // Fetch available years when the page is ready
    $(document).ready(function () {
        fetchAvailableYears();
    });
</script>

</html>