<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/global/general.css">
    <link rel="stylesheet" href="../css/local/statistics.css">
    <link href='https://fonts.googleapis.com/css?family=Poppins' rel='stylesheet'>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>
        <%= title %>
    </title>
</head>

<body>
    <%- include("../includes/header.ejs") %>

        <div class="container">
            <h2>Resident Sectors</h2>
            <div id="meow">
                <div class="chart">
                    <canvas id="barangayPopulationChart1"></canvas>
                </div>
                <div class="separate">
                    <div>
                        <div id="classificationByPurokDetails"></div>
                        <div id="overallPopulation1"></div>
                    </div>
                    <div id="totalClassificationDetails"></div>
                </div>
            </div>

            <h2>Residents Classification</h2>
            <div id="meow">
                <div class="chart">
                    <canvas id="barangayPopulationChart"></canvas>
                </div>
                <div class="separate">
                    <div id="totalsByPurokDetails"></div>
                    <div id="overallPopulation"></div>
                </div>
            </div>

            <h2>Resident Status</h2>
            <div id="meow">
                <div class="chart">
                    <canvas id="statusChart"></canvas>
                </div>
                <div class="separate">
                    <div id="residentStatusText"></div>
                </div>
            </div>

            <h2>Age Demographics</h2>
            <div id="meow">
                <div class="chart">
                    <canvas id="ageDemographicsChart"></canvas>
                </div>
                <div class="separate">
                    <div id="ageDemographicsText"></div>
                </div>
            </div>

            <div style="display: flex; align-items: center; justify-content: space-between; margin: 20px 3%;">
                <h2>Household Classification</h2>
                <button id="add-survey-button" onclick="popUp_button(this)">ADD SURVEY</button>
            </div>
            <div id="meow">
                <h1>House Classification Statistics</h1>

                <!-- Dropdown for selecting year -->
                <label for="year-dropdown">Select Year: </label>
                <select id="year-dropdown">
                    <!-- Options will be populated here -->
                </select>
            
                <!-- Display Statistics -->
                <div id="statistics-container">
                    <!-- Data will be inserted here -->
                </div>
                
                <!-- Display Overall Statistics -->
                <h2>Overall Statistics</h2>
                <div id="overall-container">
                    <!-- Overall data will be inserted here -->
                </div>
            </div>

        </div>
        <div class="pop-up" id="add-survey">

            <div class="close-container">
                <img src="../icon/close.svg" alt="" class="close_popUp">
            </div>
            <h1 class="heading">HOUSE CLASSIFICATION</h1>
            <main>
                <form id="formToAddResident" action="/statistics/house-classification-survey" method="POST">
                    <div class="add-survey-input-container">
                        <div class="row">
                            <div id="surveyPurok" class="inputWithLabel">
                                <label for="">Purok</label>
                                <select name="surveyPurok" id="surveyPurok" aria-label="Purok">
                                    <option value="Seguidila">Seguidila</option>
                                    <option value="Sitaw">Sitaw</option>
                                    <option value="Talbos">Talbos</option>
                                    <option value="Petchay">Petchay</option>
                                    <option value="Ampalaya">Ampalaya</option>
                                    <option value="Mustaza">Mustaza</option>
                                    <option value="Kalabasa">Kalabasa</option>
                                </select>
                            </div>
                            <div class="inputWithLabel">
                                <label>House Number (Optional)</label>
                                <input type="number" aria-label="House Number (Optional)" name="houseNumber" min="1">
                            </div>
                            <div class="inputWithLabel" id="surubadan">
                                <label>House Representative</label>
                                <input type="text" aria-label="House Representative" name="houseRepresentative" required>
                            </div>
                            <div class="inputWithLabel">
                                <label>Number of Families</label>
                                <input type="number" aria-label="Number of Families" name="numberOfFamilies" min="1" required>
                            </div>
                            <div class="inputWithLabel" id="masubad">
                                <label>With CR</label>
                                <select name="isWithCr" aria-label="With CR" required>
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                            <div class="inputWithLabel" id="masubad">
                                <label>With 40m Zone</label>
                                <select name="isWith40mZone" aria-label="With 40m Zone" required>
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                            <div class="inputWithLabel" id="masubad">
                                <label>Energized</label>
                                <select name="isEnergized" aria-label="Energized" required>
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                            <div class="inputWithLabel" id="masubad">
                                <label>Housing Materials</label>
                                <select name="housingMaterials" aria-label="Housing Materials" required>
                                    <option value="Concrete">Concrete</option>
                                    <option value="Semi-Concrete">Semi-Concrete</option>
                                    <option value="Wood">Wood</option>
                                </select>
                            </div>
                            <div class="inputWithLabel" id="masubad">
                                <label>Water Sources</label>
                                <div style="display: flex; gap: 12px;">
                                    <label style="display: flex; align-items: center; gap: 6px;">
                                        <input type="checkbox" name="deepWell" value="Deep Well">
                                        Deep Well
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 6px;">
                                        <input type="checkbox" name="waterPump" value="Water Pump">
                                        Water Pump
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 6px;">
                                        <input type="checkbox" name="mineral" value="Mineral">
                                        Mineral
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" id="submit_add_survey" style="display: flex; margin-left: auto;">SUBMIT</button>
                </form>                
            </main>
        </div>

</body>
<script src="../../js/global/pop-up.js"></script>
<script src="../../js/local/statistics/statistics-api.js"></script>
<script>
    document.querySelector("header>nav>ul>li:nth-child(6)").classList.toggle("selected");
</script>

<script>
    function fetchAvailableYears() {
            $.get('/statistics/available-years', function(data) {
                const yearDropdown = $('#year-dropdown');
                yearDropdown.empty(); // Clear any existing options

                // Populate the dropdown with years
                data.forEach(item => {
                    yearDropdown.append(new Option(item.year, item.year));
                });

                // Optionally, set the default selected year to the first available one
                if (data.length > 0) {
                    fetchStatistics(data[0].year); // Fetch data for the first available year
                    yearDropdown.val(data[0].year); // Set the default year in the dropdown
                }
            }).fail(function() {
                alert('Failed to fetch available years');
            });
        }

        // Fetch statistics for the selected year
        function fetchStatistics(year) {
            $.get(`/statistics/house-classification?year=${year}`, function(data) {
                // Display the year
                $('#year').text(data.year);

                // Display individual statistics by purok
                let statisticsHtml = '<table><tr><th>Purok</th><th>Total House Classifications</th><th>Total Families</th><th>Total with CR</th><th>Total with 40m Zone</th><th>Total Energized</th><th>Housing Materials</th><th>Water Source</th></tr>';
                data.statistics.forEach(stat => {
                    statisticsHtml += `
                        <tr>
                            <td>${stat.purok}</td>
                            <td>${stat.total_house_classifications}</td>
                            <td>${stat.total_families}</td>
                            <td>${stat.total_with_cr}</td>
                            <td>${stat.total_with_40m_zone}</td>
                            <td>${stat.total_energized}</td>
                            <td>${stat.housing_materials}</td>
                            <td>${stat.water_source}</td>
                        </tr>
                    `;
                });
                statisticsHtml += '</table>';
                $('#statistics-container').html(statisticsHtml);

                // Display overall statistics
                let overallHtml = `
                    <p>Total House Classifications: ${data.overall.overall_house_classifications}</p>
                    <p>Total Families: ${data.overall.overall_families}</p>
                    <p>Total with CR: ${data.overall.overall_with_cr}</p>
                    <p>Total with 40m Zone: ${data.overall.overall_with_40m_zone}</p>
                    <p>Total Energized: ${data.overall.overall_energized}</p>
                `;
                $('#overall-container').html(overallHtml);
            }).fail(function() {
                alert('Failed to fetch statistics');
            });
        }

        // Update statistics when a new year is selected
        $('#year-dropdown').change(function() {
            const selectedYear = $(this).val();
            fetchStatistics(selectedYear); // Fetch and display data for the selected year
        });

        // Fetch available years when the page is ready
        $(document).ready(function() {
            fetchAvailableYears();
        });
</script>

</html>